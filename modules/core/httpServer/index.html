<!DOCTYPE html>
<html>
<head>
<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
</style>
</head>
<body>

<h2>RCON Settings</h2>

<form action="/set_general_settings.json" method="post">
  <label for="token">Discord Token:</label><input type="text" id="token" name="token" value="Enter your token here" size="70" ><br>
  <label for="prefix">Command prefix:</label><input type="text" id="prefix" name="prefix" value="!"><br>  
  <label for="push_channel">Push status to channel:</label><input type="text" id="push_channel" name="push_channel" value=""><br>
  <input type="submit" value="Submit" onclick="return confirm('You need to restart the bot to apply changes')">
</form>
<br>

<form action="/terminate_bot.json" method="post">
  <input type="submit" value="Shutdown Bot" onclick="return confirm('Are you sure?')">
</form>
<form action="/restart_bot.json" method="post">
  <input type="submit" value="Restart Bot" onclick="return confirm('Are you sure?')">
</form>
<br>


<div id="module_settings">

</div>
<br>
<form action="/add_role.json" method="post">
  <label for="add_role">Add Role:</label><br>
  <input type="text" id="add_role" name="add_role" value=""><br>
  <input type="submit" value="Submit">
</form> 


<table id="permission_settings">

</table>


</body>

</html>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">

permission_settings = document.getElementById("permission_settings");


function generateTableHead(table, data) {
	data.unshift("Command");
	let thead = table.createTHead();
	let row = thead.insertRow();
	for (let key of data) {
		let th = document.createElement("th");
		let text = document.createTextNode(key);
		th.appendChild(text);
		row.appendChild(th);
		if(key != "Command") {
			th.appendChild(generate_delete_role_button(key)); 
			th.appendChild(generate_role_all_button(key)); 
			th.appendChild(generate_role_deall_button(key)); 
		}
		}
}

function generateTable(table, data) {
	var enabled =  data["registered"]; //TODO: get only commands with decorator
	delete data["registered"];
	jQuery.each(data, function(i, val) {
		let row = table.insertRow(); 
		let cell = row.insertCell();
		let text = document.createTextNode(i);
		cell.appendChild(text);
		var name = i;
		jQuery.each(data[i], function(i, val) {
			if(enabled.includes(name)) {
				let cell = row.insertCell();
				//let text = document.createTextNode(val);
				cell.appendChild(createCheckbox(i, name, val));
			}

		});
	});

}

function generate_delete_role_button(name) {
	var button = document.createElement('input');
	button.setAttribute('type', 'submit');
	button.setAttribute('ID', name);
	button.setAttribute('title', "Delete the role");
	button.setAttribute('value', 'X');
	button.setAttribute('onclick', 'delete_role(this)');
	button.setAttribute('form', 'myform');
	return button	
}

function generate_role_all_button(name) {
	var button = document.createElement('input');
	button.setAttribute('type', 'submit');
	button.setAttribute('ID', name);
	button.setAttribute('title', "Enable all permissions");
	button.setAttribute('value', 'All');
	button.setAttribute('onclick', 'active_all_role(this)');
	button.setAttribute('form', 'myform');
	return button	
}

function generate_role_deall_button(name) {
	var button = document.createElement('input');
	button.setAttribute('type', 'submit');
	button.setAttribute('ID', name);
	button.setAttribute('title', "Disable all permissions");
	button.setAttribute('value', 'None');
	button.setAttribute('onclick', 'active_deall_role(this)');
	button.setAttribute('form', 'myform');
	return button	
}

function delete_role(e) {
	if(confirm("Are you sure you want to delete the role "+e.id+"?")) {
		$.post('/delete_role.json', { 
		delete_role: e.id
		}, function(data) { 
			//console.log(data);
		});
		window.location.reload(false);
	}	
};

function active_all_role(e) {
	$.post('/active_all_role.json', { 
	role: e.id
	}, function(data) { 
		//console.log(data);
	});
	window.location.reload(false);
};
	
function active_deall_role(e) {
	$.post('/active_deall_role.json', { 
	role: e.id
	}, function(data) { 
		//console.log(data);
	});
	window.location.reload(false);
};


function createCheckbox(parent, command, value) {
	var x = document.createElement("INPUT");
	x.setAttribute("type", "checkbox");
	x.checked = value;
	x.id = "command_"+command;
	x.value = parent;
	x.onchange = permission_changed;
	return x;
}; 

function permission_changed(e) {
	$.post('/set_settings.json', { 
	name: e.srcElement.id,
	value: e.srcElement.checked,
	role: e.srcElement.value
	}, function(data) { 
		//console.log(data);
	});
};

$.post('/get_settings.json', { 
	}, function(data) { 
		//console.log(data);
		generateTableHead(permission_settings, data["head"])
		delete data["head"];
		generateTable(permission_settings, data)
});

$.post('/get_general_settings.json', { 
	}, function(data) { 
		//console.log(data);
		document.getElementById("token").value = data["TOKEN"]
		document.getElementById("prefix").value = data["BOT_PREFIX"]
		document.getElementById("push_channel").value = data["PUSH_CHANNEL"]
});

$.post('/get_module_settings.json', { 
	}, function(data) { 
		var main_div_p = document.getElementById("module_settings");
		//console.log(data);
		jQuery.each(data, function(key, val) {
			
			var main_div = document.createElement("form");
			main_div.action="/set_module_settings::"+key+".json";
			main_div.method="post";
			main_div.id="module_settings";
			main_div_p.appendChild(main_div);
			//Create Title
			var element = document.createElement("h2");
			element.innerHTML = key;
			main_div.appendChild(element);  
			
			//Create Otions
			jQuery.each(data[key], function(key, val) {
				var element = document.createElement("label");
				element.innerHTML = key+": ";
				main_div.appendChild(element);  
				var element = document.createElement("input");
				element.type = "text";
				element.id = key;
				element.name = key;
				element.value = val;
				main_div.appendChild(element);  
				var element = document.createElement("br");
				main_div.appendChild(element); 
			});
			var element = document.createElement("input");
			element.type = "submit";
			element.value = "Submit";
			element.onclick = "return confirm('Are you sure?')";		
			main_div.appendChild(element); 


		});
});

</script>